<template>
    <div>
        <label>Pipeline name
        <input type="text" v-on:change="queryPipeline($event)"></label>


        <div class="topics-container">
            <div v-for="item in this.topics" v-bind:key="item.name" style="display: flex">
                <Topic v-bind:topic="item" v-on:topicSelected="topicSelected($event)">
                </Topic>
                <div v-if="item !== topics[topics.length - 1]">
                    <svg height="5px" width="100px">
                        <line x1="0" y1="0" x2="100" y2="0" style="stroke:rgb(0,0,0);stroke-width:5"/>
                    </svg>
                </div>
            </div>

        </div>
        <TopicData v-if="selectedTopicData" v-bind:topic-data="this.selectedTopicData"></TopicData>


        <div v-bind:style="getStyle(getMaxValue())" class="max-value">
            <span v-if="topics && topics.length">
            Pipeline value {{getMaxValue()}}
                </span>
        </div>
    </div>
</template>

<style scoped >
    input {
        border-radius: 7px;
        border-width: 1px;
        width: 200px;
        height: 20px;
        border-style: solid;
        outline: none;
        font-size: 16px;
    ;

    }
    .max-value {
       font-size: 20px;
        margin-top: 10px;
    }
    div.topics-container {
        display: flex;
        justify-content: center;
        max-width: 70em;
        overflow-x: scroll;
        margin-top: 10px;

    }
    div.topics-container div {
        align-self: center;
    }

</style>

<script>


    import {Vue} from "vue-property-decorator";
    import Component from "vue-class-component";
    import Topic from "@/components/Topic";
    import TopicData from "@/components/TopicData";
    import {TopicsService} from "@/services/topics-service.js";

    const topicsService = new TopicsService();
    @Component({
        components: {TopicData, Topic},
        props: {
            msg: {
                default: ''
            },

        }

    })
    export default class HeatMap extends Vue {
        topics = [];
        selectedTopicData = null;

        queryPipeline(changeEvent) {
            const pipelineName = changeEvent.target.value;
            this.pipelineName = pipelineName;
            this.getTopics(pipelineName);
        }

        getMaxValue() {
            if (!this.topics || !this.topics.length) {
                return null;
            }
            return this.topics.map( t=> t.value ).reduce((accumolator, value) =>  value > accumolator ? value : accumolator);
        }

        getStyle(maxValue) {
            return {'background-color':  topicsService.getColor(10 - maxValue)};
        }

        async getTopics(pipelineName) {

            if (this.timer) {
                clearTimeout(this.timer);
            }

            this.timer = setTimeout(() => this.getTopics(pipelineName), 10000);
            try {
                this.topics = await topicsService.getTopics(pipelineName);
            } catch(err) {
                this.topics = [];
            }


        }

        async topicSelected(topic) {
            this.selectedTopicData = await topicsService.getTopicData(this.pipelineName, topic);


        }
        addTopic() {
            topicsService.queryTopics(this.pipelineName, this.$refs.topicNames.value);
        }

    }
</script>


